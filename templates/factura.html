<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBill - Factură</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<style>
/* Notificări personalizate în loc de toastr */
.custom-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 5px;
    color: white;
    font-weight: bold;
    z-index: 9999;
    animation: slideIn 0.3s ease;
}

.custom-notification.success {
    background: #4CAF50;
}

.custom-notification.error {
    background: #f44336;
}

.custom-notification.info {
    background: #2196F3;
}

.custom-notification.warning {
    background: #ff9800;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
</style>

<script>
// Înlocuitor simplu pentru toastr
const customToastr = {
    success: function(message, title = '') {
        this.show(message, title, 'success');
    },
    error: function(message, title = '') {
        this.show(message, title, 'error');
    },
    info: function(message, title = '') {
        this.show(message, title, 'info');
    },
    warning: function(message, title = '') {
        this.show(message, title, 'warning');
    },
    show: function(message, title, type) {
        console.log(`📢 ${type.toUpperCase()}: ${title ? title + ' - ' : ''}${message}`);
        
        // Creează notificarea
        const notification = document.createElement('div');
        notification.className = `custom-notification ${type}`;
        notification.innerHTML = `${title ? '<strong>' + title + '</strong><br>' : ''}${message}`;
        
        // Adaugă la pagină
        document.body.appendChild(notification);
        
        // Îndepărtează după 5 secunde
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 5000);
    }
};

// Înlocuiește toastr cu versiunea personalizată
window.toastr = customToastr;
</script>

    <style>
        .invoice-container {
            padding: 30px;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .invoice-title {
            font-size: 24px;
            color: var(--dark);
            font-weight: 300;
        }
        
        .invoice-form {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 30px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }
        
        .products-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }
        
        .add-product-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .add-product-btn:hover {
            background: #229954;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .products-table th {
            background: var(--primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }
        
        .products-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: white;
        }
        
        .products-table tr:hover td {
            background: #f8f9fa;
        }
        
        .product-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .remove-product-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-product-btn:hover {
            background: #c0392b;
        }
        
        .totals-section {
            background: var(--light);
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .total-row.final {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            border-top: 2px solid var(--border);
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .client-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .client-selector select {
            flex: 1;
        }
        
        .new-client-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 12px;
        }
        
        .new-client-btn:hover {
            background: #e67e22;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 20px;
            color: var(--dark);
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--dark);
        }

        /* Invoice Preview Modal - LARGER */
        .invoice-preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .preview-modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: var(--radius);
            width: 95%;
            max-width: 1200px;
            height: 95vh;
            overflow: hidden;
            box-shadow: 0 4px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .preview-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
        }

        .preview-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }

        .preview-tab.active {
            background: white;
            border-bottom-color: var(--primary);
            color: var(--primary);
        }

        .preview-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        .email-content {
            display: none;
        }

        .email-content.active {
            display: block;
        }

        /* Invoice Print Styles */
        .invoice-print {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
        }

        .invoice-header-print {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary);
        }

        .company-info h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .company-info p {
            margin: 5px 0;
            font-size: 14px;
        }

        .invoice-details {
            text-align: right;
        }

        .invoice-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .invoice-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .client-info, .invoice-dates {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--radius);
        }

        .info-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 16px;
        }

        .invoice-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        .invoice-items-table th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }

        .invoice-items-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .invoice-items-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .invoice-totals {
            width: 50%;
            margin-left: auto;
            margin-bottom: 40px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .total-line.final {
            font-weight: bold;
            font-size: 18px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            margin-top: 10px;
        }

        .invoice-notes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 30px;
        }

        .invoice-footer-print {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }

        /* Email Form Styles */
        .email-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .email-form .form-group {
            margin-bottom: 20px;
        }

        .email-form .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .email-form .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
        }

        .email-form .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            resize: vertical;
            min-height: 120px;
        }

        /* Preview Actions */
        .preview-actions {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-print {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
        }

        .btn-send-email {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
        }

        /* Print styles */
        @media print {
            .preview-tabs,
            .preview-actions,
            .modal-header,
            .sidebar,
            .main-content header {
                display: none !important;
            }

            .preview-modal-content {
                width: 100% !important;
            }

            .preview-content {
                padding: 0 !important;
            }

            .invoice-print {
                max-width: none !important;
                box-shadow: none !important;
            }

            body {
                background: white !important;
            }
        }

        /* Toast notifications customization */
        .toast-success {
            background-color: var(--success) !important;
        }
        
        .toast-error {
            background-color: var(--danger) !important;
        }
        
        .toast-warning {
            background-color: var(--warning) !important;
        }
        
        .toast-info {
            background-color: var(--primary) !important;
        }
        
        /* Sticky form actions for invoice form */
        .form-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0;
            border-top: 1px solid var(--border);
            margin-top: 20px;
            z-index: 10;
        }

        /* Header with Icons */
        .header {
            background: white;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .header-left {
            padding: 0 30px;
        }

        .header-left h1 {
            color: var(--dark);
            font-size: 24px;
            font-weight: 300;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 0 30px;
        }

        /* Header Icons */
        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            color: #666;
        }

        .header-icon:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .header-icon.notification::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid white;
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 25px;
            background: #f8f9fa;
            transition: var(--transition);
        }

        .user-info:hover {
            background: #e9ecef;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), #5dade2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .user-details span {
            display: block;
            font-size: 13px;
            color: var(--dark);
            font-weight: 600;
        }

        .user-details small {
            color: #666;
            font-size: 11px;
        }

        /* Dropdown Menus */
        .dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-width: 320px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
            z-index: 1000;
            margin-top: 10px;
        }

        .dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
        }

        .dropdown-header h3 {
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 18px;
        }

        .dropdown-header p {
            color: #666;
            font-size: 13px;
        }

        .dropdown-menu {
            padding: 15px;
        }

        .dropdown-section {
            margin-bottom: 20px;
        }

        .dropdown-section:last-child {
            margin-bottom: 0;
        }

        .dropdown-section-title {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            transform: translateX(3px);
        }

        .dropdown-item-icon {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .dropdown-item-content h4 {
            font-size: 14px;
            margin-bottom: 2px;
            color: var(--dark);
        }

        .dropdown-item-content p {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        /* Module Colors */
        .module-gestiune { background: linear-gradient(45deg, #667eea, #764ba2); }
        .module-productie { background: linear-gradient(45deg, #f093fb, #f5576c); }
        .module-pos { background: linear-gradient(45deg, #4facfe, #00f2fe); }
        .module-conta { background: linear-gradient(45deg, #43e97b, #38f9d7); }
        .module-transport { background: linear-gradient(45deg, #fa709a, #fee140); }

        /* Search Modal Styles */
        .search-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .search-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 16px;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .search-header {
            background: linear-gradient(135deg, var(--primary) 0%, #5dade2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-title {
            font-size: 24px;
            font-weight: 300;
            margin: 0;
        }

        .search-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px 10px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .search-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .search-filters {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border);
        }

        .search-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .search-group {
            display: flex;
            flex-direction: column;
        }

        .search-label {
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .search-input {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .search-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-search {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-search:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-reset {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-reset:hover {
            background: #7f8c8d;
        }

        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-count {
            font-size: 16px;
            color: var(--dark);
            font-weight: 500;
        }

        .btn-export {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-export:hover {
            background: #229954;
        }

        /* Excel-style Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: #f8f9fa;
            color: var(--dark);
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: var(--dark);
            vertical-align: middle;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .results-table tr:nth-child(even) {
            background: #fbfbfb;
        }

        .results-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-emisa {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-platita {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-anulata {
            background: #ffebee;
            color: #c62828;
        }

        /* Amount formatting */
        .amount {
            text-align: right;
            font-weight: 600;
            color: var(--success);
        }

        /* Action buttons in table */
        .table-action {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: var(--transition);
            font-size: 12px;
        }

        .table-action:hover {
            background: var(--primary);
            color: white;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading i {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 20px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* No results state */
        .no-results {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .no-results i {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 20px;
        }

        /* Responsive table */
        @media (max-width: 1200px) {
            .results-table {
                font-size: 12px;
            }
            
            .results-table th,
            .results-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h2>💰 SmartBill</h2>
                <span>FACTURARE</span>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-item">📊 Dashboard</a>
                <div class="nav-group">
                    <span class="nav-title">📄 Emitere</span>
                    <a href="/factura" class="nav-subitem active">Factură</a>
                    <a href="/bon-fiscal" class="nav-subitem">Bon Fiscal</a>
                    <a href="/factura-storno" class="nav-subitem">Factură Storno</a>
                </div>
                <a href="/rapoarte" class="nav-item">📈 Rapoarte</a>
                <a href="/configurare" class="nav-item">⚙️ Configurare</a>
                <div class="nav-group">
                    <span class="nav-title">📝 Nomenclatoare</span>
                    <a href="/produse" class="nav-subitem">Produse</a>
                    <a href="/clienti" class="nav-subitem">Clienți</a>
                </div>
            </nav>
        </div>

        <div class="main-content">
            <!-- Header with Icons -->
            <div class="header">
                <div class="header-left">
                    <h1>Factură</h1>
                </div>
                
                <div class="header-right">
                    <!-- Search Icon -->
                    <button class="header-icon" title="Căutare">
                        <i class="fas fa-search"></i>
                    </button>
                    
                    <!-- Apps Grid Icon -->
                    <button class="header-icon" id="appsButton" title="Module">
                        <i class="fas fa-th"></i>
                    </button>
                    
                    <!-- Notifications -->
                    <button class="header-icon notification" title="Notificări">
                        <i class="fas fa-bell"></i>
                    </button>
                    
                    <!-- Help -->
                    <button class="header-icon" id="helpButton" title="Ajutor">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    
                    <!-- User Menu -->
                    <div class="user-menu">
                        <div class="user-info" id="userButton">
                            <div class="user-avatar">NF</div>
                            <div class="user-details">
                                <span>TIP B. SRL</span>
                                <small>Sediu principal</small>
                            </div>
                            <i class="fas fa-chevron-down" style="color: #666; font-size: 12px;"></i>
                        </div>
                        
                        <!-- User Dropdown -->
                        <div class="dropdown" id="userDropdown">
                            <div class="dropdown-header">
                                <h3>Neculai Fantanaru</h3>
                                <p>ioan.fantanaru@gmail.com</p>
                            </div>
                            <div class="dropdown-menu">
                                <div class="dropdown-section">
                                    <a href="#" class="dropdown-item">
                                        <div class="dropdown-item-icon" style="background: linear-gradient(45deg, #667eea, #764ba2);">
                                            <i class="fas fa-star"></i>
                                        </div>
                                        <div class="dropdown-item-content">
                                            <h4>Platinum</h4>
                                            <p>20 zile rămase</p>
                                        </div>
                                    </a>
                                </div>
                                
                                <div class="dropdown-section">
                                    <div class="dropdown-section-title">Acțiuni</div>
                                    <a href="#" class="dropdown-item">
                                        <div class="dropdown-item-icon" style="background: var(--success);">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                        <div class="dropdown-item-content">
                                            <h4>Adaugă o firmă nouă</h4>
                                        </div>
                                    </a>
                                    <a href="#" class="dropdown-item">
                                        <div class="dropdown-item-icon" style="background: var(--danger);">
                                            <i class="fas fa-sign-out-alt"></i>
                                        </div>
                                        <div class="dropdown-item-content">
                                            <h4>Deconectare</h4>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Apps/Modules Dropdown -->
            <div class="dropdown" id="appsDropdown" style="right: 120px; top: 60px;">
                <div class="dropdown-header">
                    <h3>Module adiționale</h3>
                    <p>Alege modulele care te interesează. Solicită activarea acestora și în scurt timp vei fi contactat de către echipa SmartBill.</p>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon module-gestiune">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>GESTIUNE</h4>
                                <p>Ai tot ce ține de gestiune și facturare de la A la Z. De la 14,84 €/lună + TVA.</p>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon module-productie">
                                <i class="fas fa-industry"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>PRODUCȚIE</h4>
                                <p>Poți înregistra rapid rețete și rapoarte de producție. 7,48 €/lună + TVA.</p>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon module-pos">
                                <i class="fas fa-cash-register"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>POS (Point of Sale)</h4>
                                <p>Aplicația Numărul 1 pentru magazine și pentru vânzare în general. De la 9,9 €/lună + TVA.</p>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon module-conta">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>CONTA</h4>
                                <p>O schimbare de paradigmă, nu doar un alt program de contabilitate.</p>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon module-transport">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>E-TRANSPORT</h4>
                                <p>Poți întoarce notificări e-Transport ce pot fi trimise direct în SPV. De la 1,99 EUR/lună + TVA.</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Help Dropdown -->
            <div class="dropdown" id="helpDropdown" style="right: 80px; top: 60px;">
                <div class="dropdown-header">
                    <h3>Centru de suport</h3>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-section">
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon" style="background: var(--primary);">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>Ghid e-Factură</h4>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon" style="background: var(--success);">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>Ghidul aplicației</h4>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon" style="background: var(--warning);">
                                <i class="fas fa-video"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>Tutoriale video</h4>
                            </div>
                        </a>
                        
                        <a href="#" class="dropdown-item">
                            <div class="dropdown-item-icon" style="background: var(--danger);">
                                <i class="fas fa-code"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>Documentație API</h4>
                            </div>
                        </a>
                    </div>
                    
                    <div class="dropdown-section">
                        <div class="dropdown-section-title">Contact</div>
                        <a href="mailto:cloud@smartbill.ro" class="dropdown-item">
                            <div class="dropdown-item-icon" style="background: var(--primary);">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="dropdown-item-content">
                                <h4>Email: cloud@smartbill.ro</h4>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <div class="invoice-container">
                <div class="invoice-header">
                    <h2 class="invoice-title">Factură Nouă</h2>
                </div>

                <form id="invoiceForm" class="invoice-form">
                    <!-- Informații Factură -->
                    <div class="form-section">
                        <h3 class="section-title">Informații Factură</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Număr Factură</label>
                                <input type="text" class="form-input" id="invoiceNumber" value="FACT-001" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Data Emiterii</label>
                                <input type="date" class="form-input" id="invoiceDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Data Scadenței</label>
                                <input type="date" class="form-input" id="dueDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Termeni de Plată</label>
                                <select class="form-select" id="paymentTerms">
                                    <option value="30 zile">30 zile</option>
                                    <option value="15 zile">15 zile</option>
                                    <option value="7 zile">7 zile</option>
                                    <option value="Plată imediată">Plată imediată</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Informații Client -->
                    <div class="form-section">
                        <h3 class="section-title">Informații Client</h3>
                        <div class="client-selector">
                            <select class="form-select" id="clientSelect" required>
                                <option value="">Selectează client...</option>
                            </select>
                            <button type="button" class="new-client-btn" onclick="openNewClientModal()">
                                ➕ Client Nou
                            </button>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nume Client</label>
                                <input type="text" class="form-input" id="clientName" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CIF/CNP</label>
                                <input type="text" class="form-input" id="clientCIF" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="clientEmail" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Telefon</label>
                                <input type="tel" class="form-input" id="clientPhone" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Adresa</label>
                            <textarea class="form-textarea" id="clientAddress" readonly></textarea>
                        </div>
                    </div>

                    <!-- Produse și Servicii -->
                    <div class="form-section">
                        <h3 class="section-title">Produse și Servicii</h3>
                        <div class="products-section">
                            <button type="button" class="add-product-btn" onclick="addProductRow()">
                                ➕ Adaugă Produs
                            </button>
                            <table class="products-table" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>Produs/Serviciu</th>
                                        <th>UM</th>
                                        <th>Cantitate</th>
                                        <th>Preț Unitar</th>
                                        <th>TVA %</th>
                                        <th>Valoare</th>
                                        <th>Acțiuni</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Rândurile de produse vor fi adăugate dinamic -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Totaluri -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">0.00 RON</span>
                        </div>
                        <div class="total-row">
                            <span>TVA:</span>
                            <span id="tva">0.00 RON</span>
                        </div>
                        <div class="total-row final">
                            <span>TOTAL:</span>
                            <span id="total">0.00 RON</span>
                        </div>
                    </div>

                    <!-- Observații -->
                    <div class="form-section">
                        <h3 class="section-title">Observații</h3>
                        <div class="form-group">
                            <textarea class="form-textarea" id="invoiceNotes" placeholder="Observații pentru factură..."></textarea>
                        </div>
                    </div>

                    <!-- Acțiuni -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="window.location.href='/dashboard'">
                            Anulează
                        </button>
                        <button type="button" class="btn-secondary" onclick="saveDraft()">
                            Salvează Ciornă
                        </button>
                        <button type="submit" class="btn-success">
                            Emite Factura
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal pentru client nou -->
    <div id="newClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adaugă Client Nou</h3>
                <span class="close" onclick="closeNewClientModal()">&times;</span>
            </div>
            <form id="newClientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">CIF/CNP</label>
                        <input type="text" class="form-input" id="newClientCIF" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nume Client</label>
                        <input type="text" class="form-input" id="newClientName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="newClientEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input type="tel" class="form-input" id="newClientPhone" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresa</label>
                    <textarea class="form-textarea" id="newClientAddress" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeNewClientModal()">Anulează</button>
                    <button type="submit" class="btn-primary">Salvează Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Preview Factură -->
    <div id="invoicePreviewModal" class="invoice-preview-modal">
        <div class="preview-modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Previzualizare Factură</h3>
                <span class="close" onclick="closePreviewModal()">&times;</span>
            </div>
            
            <div class="preview-tabs">
                <div class="preview-tab active" onclick="showPreviewTab('print')">
                    🖨️ Previzualizare Print
                </div>
                <div class="preview-tab" onclick="showPreviewTab('email')">
                    📧 Trimitere Email
                </div>
            </div>
            
            <div class="preview-content">
                <!-- Print Content -->
                <div id="printContent" class="print-content">
                    <div class="invoice-print" id="invoicePrintContent">
                        <!-- Conținutul facturii pentru print va fi generat dinamic -->
                    </div>
                </div>

                <!-- Email Content -->
                <div id="emailContent" class="email-content">
                    <div class="email-form">
                        <div class="form-group">
                            <label class="form-label">Adresa Email Destinatar</label>
                            <input type="email" class="form-input" id="emailTo" placeholder="client@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CC (opțional)</label>
                            <input type="email" class="form-input" id="emailCC" placeholder="neculai.fantanaru@gmail.com, me.suzana@gmail.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subiect</label>
                            <input type="text" class="form-input" id="emailSubject" value="Factură">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mesaj</label>
                            <textarea class="form-textarea" id="emailMessage" placeholder="Bună ziua,

Vă trimit atașată factura pentru serviciile prestate.

Vă mulțumesc pentru colaborare.

Cu stimă,
TIP B. SRL"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="attachPDF" checked> Atașează factura ca PDF
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preview-actions">
                <button type="button" class="btn-secondary" onclick="closePreviewModal()">
                    Închide
                </button>
                <button type="button" class="btn-print" onclick="printInvoice()" id="printBtn">
                    🖨️ Imprimă
                </button>
                <button type="button" class="btn-send-email" onclick="sendInvoiceEmail()" id="emailBtn" style="display: none;">
                    📧 Trimite Email
                </button>
            </div>
        </div>
    </div>

    <!-- Search Modal -->
    <div id="searchModal" class="search-modal">
        <div class="search-modal-content">
            <div class="search-header">
                <h2 class="search-title">🔍 Căutare Facturi</h2>
                <button class="search-close" onclick="closeSearchModal()">&times;</button>
            </div>
            
            <div class="search-filters">
                <div class="search-filters-grid">
                    <div class="search-group">
                        <label class="search-label">Număr Factură</label>
                        <input type="text" class="search-input" id="searchInvoiceNumber" placeholder="ex: FACT-001">
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">Nume Client</label>
                        <input type="text" class="search-input" id="searchClientName" placeholder="ex: Ionescu Maria">
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">CIF Client</label>
                        <input type="text" class="search-input" id="searchClientCIF" placeholder="ex: RO12345678">
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">Data de la</label>
                        <input type="date" class="search-input" id="searchDateFrom">
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">Data până la</label>
                        <input type="date" class="search-input" id="searchDateTo">
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">Status</label>
                        <select class="search-input" id="searchStatus">
                            <option value="">Toate</option>
                            <option value="emisa">Emisă</option>
                            <option value="platita">Plătită</option>
                            <option value="anulata">Anulată</option>
                        </select>
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">Suma minimă (RON)</label>
                        <input type="number" class="search-input" id="searchMinAmount" placeholder="0.00" step="0.01">
                    </div>
                    
                    <div class="search-group">
                        <label class="search-label">Suma maximă (RON)</label>
                        <input type="number" class="search-input" id="searchMaxAmount" placeholder="999999.99" step="0.01">
                    </div>
                </div>
                
                <div class="search-actions">
                    <button type="button" class="btn-reset" onclick="resetSearchFilters()">
                        🔄 Resetează Filtrele
                    </button>
                    <button type="button" class="btn-search" onclick="searchInvoices()" style="background: #3498db;">
                        🔍 Caută Facturi (Real)
                    </button>
                    <button type="button" class="btn-search" onclick="searchInvoicesMock()" style="background: #9b59b6;">
                        🧪 Test cu Date Mock
                    </button>
                    <button type="button" class="btn-search" onclick="testSearchEndpoint()" style="background: #f39c12;">
                        🔧 Test Endpoint
                    </button>
                </div>
            </div>
            
            <div class="search-results">
                <div class="results-header">
                    <div class="results-count" id="resultsCount">
                        Introduceți criteriile de căutare și apăsați "Caută Facturi"
                    </div>
                    <button type="button" class="btn-export" onclick="exportResults()" id="exportBtn" style="display: none;">
                        📊 Export Excel
                    </button>
                </div>
                
                <div id="searchResultsContainer">
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Căutați facturile dvs.</h3>
                        <p>Utilizați filtrele de mai sus pentru a găsi facturile dorite</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        // Initialize toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "5000",
            "extendedTimeOut": "2000"
        };

        let clients = [];
        let products = [];
        let productCounter = 0;
        let currentInvoiceData = null;

        // Configurare email pentru aplicația SmartBill
        const EMAIL_CONFIG = {
            default_cc: 'neculai.fantanaru@gmail.com, me.suzana@gmail.com',
            sender_info: {
                company: 'TIP B. SRL',
                email: 'ioan.fantanaru@gmail.com',
                phone: '021 123 4567'
            }
        };

        // Încarcă datele la pornirea paginii
        console.log('=== FACTURA.HTML SCRIPT LOADED ===');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded pentru factura.html');
            
            // Set current date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            
            loadClients();
            loadProducts().then(() => {
                addProductRow(); // Adaugă primul rând de produs după ce produsele sunt încărcate
            });
            setDefaultDueDate();
        });

        function loadClients() {
            fetch('/api/get_clienti')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    clients = data;
                    populateClientSelect();
                    toastr.success('Clienții au fost încărcați cu succes!');
                })
                .catch(error => {
                    console.error('Eroare la încărcarea clienților pentru factură:', error);
                    toastr.error('Nu s-au putut încărca clienții: ' + error.message);
                });
        }

        function loadProducts() {
            return fetch('/api/get_produse')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    products = data;
                    toastr.success('Produsele au fost încărcate cu succes!');
                    return data;
                })
                .catch(error => {
                    console.error('Eroare la încărcarea produselor pentru factură:', error);
                    toastr.error('Nu s-au putut încărca produsele: ' + error.message);
                    return [];
                });
        }

        function populateClientSelect() {
            console.log('=== POPULATE CLIENT SELECT ===');
            console.log('Clienți disponibili pentru combo:', clients);
            console.log('Număr clienți:', clients.length);
            
            const select = document.getElementById('clientSelect');
            console.log('Select element:', select);
            
            if (!select) {
                console.error('Elementul clientSelect nu a fost găsit!');
                return;
            }
            
            select.innerHTML = '<option value="">Selectează client...</option>';
            console.log('Select golit și opțiunea default adăugată');
            
            if (clients.length === 0) {
                console.log('Nu sunt clienți de adăugat în combo');
                return;
            }
            
            clients.forEach((client, index) => {
                console.log(`Adaug clientul ${index + 1}:`, client);
                const option = document.createElement('option');
                option.value = client.ID;
                option.textContent = `${client.Nume} (${client.CIF})`;
                select.appendChild(option);
                console.log(`Client ${index + 1} adăugat în combo`);
            });
            console.log('Combo-box clienți populat cu', clients.length, 'opțiuni');
        }

        function setDefaultDueDate() {
            const today = new Date();
            const dueDate = new Date(today);
            dueDate.setDate(today.getDate() + 30);
            
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
        }

        function addProductRow() {
            const tbody = document.getElementById('productsTableBody');
            const row = document.createElement('tr');
            row.id = `product-row-${productCounter}`;
            
            row.innerHTML = `
                <td>
                    <select class="product-input product-select" onchange="updateProductInfo(${productCounter})">
                        <option value="">Selectează produs...</option>
                        ${products.map(p => `<option value="${p.ID}">${p.Denumire}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" class="product-input" id="um-${productCounter}" readonly></td>
                <td><input type="number" class="product-input" id="qty-${productCounter}" value="1" min="1" onchange="calculateRowTotal(${productCounter})"></td>
                <td><input type="number" class="product-input" id="price-${productCounter}" step="0.01" onchange="calculateRowTotal(${productCounter})"></td>
                <td><input type="number" class="product-input" id="tva-${productCounter}" value="19" min="0" max="100" onchange="calculateRowTotal(${productCounter})"></td>
                <td><input type="text" class="product-input" id="total-${productCounter}" readonly></td>
                <td>
                    <button type="button" class="remove-product-btn" onclick="removeProductRow(${productCounter})">
                        🗑️
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
            productCounter++;
        }

        function updateProductInfo(rowIndex) {
            const select = document.getElementById(`product-row-${rowIndex}`).querySelector('.product-select');
            const productId = select.value;
            const product = products.find(p => p.ID == productId);
            
            if (product) {
                document.getElementById(`um-${rowIndex}`).value = product.UM;
                document.getElementById(`price-${rowIndex}`).value = product.Pret_Vanzare;
                calculateRowTotal(rowIndex);
            }
        }

        function calculateRowTotal(rowIndex) {
            const qty = parseFloat(document.getElementById(`qty-${rowIndex}`).value) || 0;
            const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
            const tvaPercent = parseFloat(document.getElementById(`tva-${rowIndex}`).value) || 0;
            
            const subtotal = qty * price;
            const tva = subtotal * (tvaPercent / 100);
            const total = subtotal + tva;
            
            document.getElementById(`total-${rowIndex}`).value = total.toFixed(2);
            calculateInvoiceTotals();
        }

        function removeProductRow(rowIndex) {
            const row = document.getElementById(`product-row-${rowIndex}`);
            if (row) {
                row.remove();
                calculateInvoiceTotals();
            }
        }

        function calculateInvoiceTotals() {
            let subtotal = 0;
            let tva = 0;
            
            const rows = document.querySelectorAll('#productsTableBody tr');
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('input[id^="qty-"]').value) || 0;
                const price = parseFloat(row.querySelector('input[id^="price-"]').value) || 0;
                const tvaPercent = parseFloat(row.querySelector('input[id^="tva-"]').value) || 0;
                
                const rowSubtotal = qty * price;
                const rowTva = rowSubtotal * (tvaPercent / 100);
                
                subtotal += rowSubtotal;
                tva += rowTva;
            });
            
            const total = subtotal + tva;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' RON';
            document.getElementById('tva').textContent = tva.toFixed(2) + ' RON';
            document.getElementById('total').textContent = total.toFixed(2) + ' RON';
        }

		// Gestionează selectarea clientului
		document.getElementById('clientSelect').addEventListener('change', function() {
			const clientId = this.value;
			const client = clients.find(c => c.ID == clientId);
			
			// DEBUG: Verifică ce câmpuri are clientul
			console.log('🔍 Client selectat:', client);
			console.log('🔍 Câmpuri disponibile:', Object.keys(client || {}));
			
			if (client) {
				document.getElementById('clientName').value = client.Nume;
				document.getElementById('clientCIF').value = client.CIF;
				document.getElementById('clientEmail').value = client.Client_Email || '';
				document.getElementById('clientPhone').value = client.Client_Telefon || '';
				document.getElementById('clientAddress').value = client.Client_Adresa || '';
				
				// DEBUG: Verifică valorile setate
				console.log('✅ Email setat:', client.Client_Email);
				console.log('✅ Telefon setat:', client.Client_Telefon);
			} else {
				document.getElementById('clientName').value = '';
				document.getElementById('clientCIF').value = '';
				document.getElementById('clientEmail').value = '';
				document.getElementById('clientPhone').value = '';
				document.getElementById('clientAddress').value = '';
			}
		});

		

        // Gestionează trimiterea facturii - deschide preview în loc să salveze direct
        document.getElementById('invoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('📄 Formularul de factură a fost trimis');
            
            // Validări
            const clientId = document.getElementById('clientSelect').value;
            if (!clientId) {
                toastr.error('❌ Vă rugăm să selectați un client');
                return;
            }

            const rows = document.querySelectorAll('#productsTableBody tr');
            if (rows.length === 0) {
                toastr.error('❌ Vă rugăm să adăugați cel puțin un produs');
                return;
            }

            // Verifică dacă toate produsele au preț
            let hasValidProduct = false;
            rows.forEach(row => {
                const price = parseFloat(row.querySelector('input[id^="price-"]').value) || 0;
                if (price > 0) hasValidProduct = true;
            });

            if (!hasValidProduct) {
                toastr.error('❌ Vă rugăm să completați prețurile pentru produse');
                return;
            }

            console.log('✅ Toate validările au trecut');

            // Pregătește datele facturii pentru preview
            try {
                currentInvoiceData = prepareInvoiceData();
                console.log('📊 Date factură pregătite:', currentInvoiceData);
                
                // Deschide modalul de previzualizare
                openPreviewModal();
                
            } catch (error) {
                console.error('❌ Eroare la pregătirea datelor:', error);
                toastr.error('❌ Eroare la pregătirea facturii: ' + error.message);
            }
        });

        function prepareInvoiceData() {
            const clientId = document.getElementById('clientSelect').value;
            const selectedClient = clients.find(c => c.ID == clientId);
            
            // Colectează produsele
            const invoiceProducts = [];
            const rows = document.querySelectorAll('#productsTableBody tr');
            rows.forEach(row => {
                const productSelect = row.querySelector('.product-select');
                const productId = productSelect.value;
                const selectedProduct = products.find(p => p.ID == productId);
                
                const qty = parseFloat(row.querySelector('input[id^="qty-"]').value) || 0;
                const price = parseFloat(row.querySelector('input[id^="price-"]').value) || 0;
                const tvaPercent = parseFloat(row.querySelector('input[id^="tva-"]').value) || 0;
                
                if (qty > 0 && price > 0) {
                    const subtotal = qty * price;
                    const tva = subtotal * (tvaPercent / 100);
                    const total = subtotal + tva;
                    
                    invoiceProducts.push({
                        name: selectedProduct ? selectedProduct.Denumire : 'Produs necunoscut',
                        um: selectedProduct ? selectedProduct.UM : 'buc',
                        quantity: qty,
                        price: price,
                        tvaPercent: tvaPercent,
                        subtotal: subtotal,
                        tva: tva,
                        total: total
                    });
                }
            });

            const subtotal = parseFloat(document.getElementById('subtotal').textContent.replace(' RON', ''));
            const tva = parseFloat(document.getElementById('tva').textContent.replace(' RON', ''));
            const total = parseFloat(document.getElementById('total').textContent.replace(' RON', ''));

            return {
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                paymentTerms: document.getElementById('paymentTerms').value,
                client: selectedClient,
                products: invoiceProducts,
                subtotal: subtotal,
                tva: tva,
                total: total,
                notes: document.getElementById('invoiceNotes').value
            };
        }

        function openPreviewModal() {
            // Generează conținutul pentru print
            generatePrintContent();
            
            // Populează câmpurile email cu template personalizat
            if (currentInvoiceData.client && currentInvoiceData.client.Email) {
                document.getElementById('emailTo').value = currentInvoiceData.client.Email;
            }
            
            // Setează CC implicit cu datele configurate
            document.getElementById('emailCC').value = EMAIL_CONFIG.default_cc;
            
            document.getElementById('emailSubject').value = `Factură ${currentInvoiceData.invoiceNumber} - ${currentInvoiceData.total.toFixed(2)} RON`;
            
            // Template email personalizat pentru SmartBill
            const emailTemplate = `Bună ziua ${currentInvoiceData.client.Nume},

Vă trimit atașată factura pentru serviciile/produsele prestate.

📄 Detalii factură:
• Număr: ${currentInvoiceData.invoiceNumber}
• Data emiterii: ${formatDate(currentInvoiceData.invoiceDate)}
• Data scadenței: ${formatDate(currentInvoiceData.dueDate)}
• Total de plată: ${currentInvoiceData.total.toFixed(2)} RON

Termenul de plată este de ${currentInvoiceData.paymentTerms}.

Pentru orice întrebări sau clarificări, vă rog să mă contactați.

Mulțumesc pentru colaborare!

Cu stimă,
${EMAIL_CONFIG.sender_info.company}
📞 ${EMAIL_CONFIG.sender_info.phone}
📧 ${EMAIL_CONFIG.sender_info.email}`;

            document.getElementById('emailMessage').value = emailTemplate;
            
            // Afișează modalul
            document.getElementById('invoicePreviewModal').style.display = 'block';
            showPreviewTab('print');
        }

        function closePreviewModal() {
            document.getElementById('invoicePreviewModal').style.display = 'none';
        }

        function showPreviewTab(tabName) {
            // Actualizează tab-urile
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Afișează conținutul corespunzător
            if (tabName === 'print') {
                document.getElementById('printContent').style.display = 'block';
                document.getElementById('emailContent').style.display = 'none';
                document.getElementById('printBtn').style.display = 'inline-block';
                document.getElementById('emailBtn').style.display = 'none';
            } else if (tabName === 'email') {
                document.getElementById('printContent').style.display = 'none';
                document.getElementById('emailContent').style.display = 'block';
                document.getElementById('printBtn').style.display = 'none';
                document.getElementById('emailBtn').style.display = 'inline-block';
            }
        }

        function generatePrintContent() {
            const data = currentInvoiceData;
            const printContent = document.getElementById('invoicePrintContent');
            
            const productsRows = data.products.map(product => `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.um}</td>
                    <td>${product.quantity}</td>
                    <td>${product.price.toFixed(2)} RON</td>
                    <td>${product.tvaPercent}%</td>
                    <td>${product.total.toFixed(2)} RON</td>
                </tr>
            `).join('');

            printContent.innerHTML = `
                <div class="invoice-header-print">
                    <div class="company-info">
                        <h1>TIP B. SRL</h1>
                        <p><strong>CIF:</strong> RO12345678</p>
                        <p><strong>Nr. Reg. Com.:</strong> J40/1234/2020</p>
                        <p><strong>Adresa:</strong> Str. Exemplu, Nr. 123, București</p>
                        <p><strong>Telefon:</strong> 021 123 4567</p>
                        <p><strong>Email:</strong> office@tipb.ro</p>
                    </div>
                    <div class="invoice-details">
                        <div class="invoice-number">FACTURA</div>
                        <div class="invoice-number">${data.invoiceNumber}</div>
                    </div>
                </div>

                <div class="invoice-info-grid">
                    <div class="client-info">
                        <div class="info-title">Facturat către:</div>
                        <p><strong>${data.client.Nume}</strong></p>
                        <p>CIF: ${data.client.CIF}</p>
                        <p>Email: ${data.client.Email}</p>
                        <p>Telefon: ${data.client.Telefon}</p>
                        <p>Adresa: ${data.client.Adresa || data.client.Localitate}</p>
                    </div>
                    <div class="invoice-dates">
                        <div class="info-title">Detalii Factură:</div>
                        <p><strong>Data emiterii:</strong> ${formatDate(data.invoiceDate)}</p>
                        <p><strong>Data scadenței:</strong> ${formatDate(data.dueDate)}</p>
                        <p><strong>Termeni plată:</strong> ${data.paymentTerms}</p>
                        <p><strong>Moneda:</strong> RON</p>
                    </div>
                </div>

                <table class="invoice-items-table">
                    <thead>
                        <tr>
                            <th>Denumire</th>
                            <th>UM</th>
                            <th>Cantitate</th>
                            <th>Preț unitar</th>
                            <th>TVA</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${productsRows}
                    </tbody>
                </table>

                <div class="invoice-totals">
                    <div class="total-line">
                        <span>Subtotal:</span>
                        <span>${data.subtotal.toFixed(2)} RON</span>
                    </div>
                    <div class="total-line">
                        <span>TVA:</span>
                        <span>${data.tva.toFixed(2)} RON</span>
                    </div>
                    <div class="total-line final">
                        <span>TOTAL DE PLATĂ:</span>
                        <span>${data.total.toFixed(2)} RON</span>
                    </div>
                </div>

                ${data.notes ? `
                <div class="invoice-notes">
                    <div class="info-title">Observații:</div>
                    <p>${data.notes}</p>
                </div>
                ` : ''}

                <div class="invoice-footer-print">
                    <p>Mulțumim pentru încredere!</p>
                    <p>Această factură a fost generată electronic de SmartBill.</p>
                </div>
            `;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ro-RO');
        }

        async function printInvoice() {
            try {
                // Salvează factura înainte de print
                await saveInvoiceToDatabase();
                
                // Printează
                window.print();
                
                toastr.success('✅ Factura a fost salvată și printată cu succes!', 'Salvare reușită');
                
                // Mesajul dispare automat după 2 secunde și se închide modalul
                setTimeout(() => {
                    toastr.clear();
                    closePreviewModal();
                    // Redirectează la dashboard
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                }, 2000);
                
            } catch (error) {
                console.error('❌ Eroare la salvarea pentru print:', error);
                toastr.error('❌ Eroare la salvarea facturii: ' + error.message);
                
                // Printează oricum, chiar dacă nu s-a salvat
                window.print();
            }
        }

		async function sendInvoiceEmail() {
			console.log('📧 === ÎNCEPE TRIMITEREA EMAIL ===');
			
			const emailTo = document.getElementById('emailTo').value;
			const emailCC = document.getElementById('emailCC').value;
			const emailSubject = document.getElementById('emailSubject').value;
			const emailMessage = document.getElementById('emailMessage').value;
			const attachPDF = document.getElementById('attachPDF').checked;

			console.log('📧 Date email:', { emailTo, emailCC, emailSubject });

			if (!emailTo) {
				console.error('❌ Adresa email lipsește');
				toastr.error('❌ Vă rugăm să introduceți adresa de email a destinatarului');
				return;
			}

			if (!currentInvoiceData) {
				console.error('❌ Date factură lipsesc');
				toastr.error('❌ Nu există date de factură pentru trimitere');
				return;
			}

			// Afișează loading
			toastr.info('📧 Se trimite emailul cu factura...', 'Trimitere în curs');
			
			try {
				// Pregătește datele pentru email
				const emailData = {
					invoice_number: currentInvoiceData.invoiceNumber,
					client_name: currentInvoiceData.client.Nume,
					client_cif: currentInvoiceData.client.CIF,
					client_email: currentInvoiceData.client.Email,
					client_phone: currentInvoiceData.client.Telefon,
					issue_date: currentInvoiceData.invoiceDate,
					due_date: currentInvoiceData.dueDate,
					payment_terms: currentInvoiceData.paymentTerms,
					subtotal: currentInvoiceData.subtotal,
					tva: currentInvoiceData.tva,
					total: currentInvoiceData.total,
					
					email_to: emailTo,
					email_cc: emailCC || null,
					email_subject: emailSubject,
					email_message: emailMessage,
					attach_pdf: attachPDF
				};

				console.log('📧 Trimit email cu datele:', emailData);

				// Trimite emailul PRIMUL
				const response = await fetch('/api/send_invoice_email', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(emailData)
				});

				console.log('📧 Răspuns API:', response.status);
				const result = await response.json();
				console.log('📧 Date primite:', result);

				if (result.success) {
					console.log('✅ Email trimis cu succes!');
					toastr.success(`✅ Factura a fost trimisă cu succes la ${emailTo}!`, 'Trimitere reușită');
					
					if (emailCC) {
						toastr.success(`📧 CC trimis către: ${emailCC}`);
					}

					// Mesajul dispare automat după 2 secunde și se închide modalul
					setTimeout(() => {
						toastr.clear();
						closePreviewModal();
						
						setTimeout(() => {
							window.location.href = '/dashboard';
						}, 1000);
					}, 2000);

				} else {
					console.error('❌ Eroare la trimiterea email:', result.message);
					toastr.error(`❌ Eroare la trimiterea email-ului: ${result.message}`);
				}

			} catch (error) {
				console.error('❌ Eroare la trimiterea email:', error);
				toastr.error('❌ Nu s-a putut trimite emailul: ' + error.message);
			}
		}

        async function saveInvoiceToDatabase() {
            const invoiceData = {
                numar_factura: currentInvoiceData.invoiceNumber,
                data_emitere: currentInvoiceData.invoiceDate,
                data_scadenta: currentInvoiceData.dueDate,
                client_cif: currentInvoiceData.client.CIF,
                client_nume: currentInvoiceData.client.Nume,
                client_email: currentInvoiceData.client.Email,
                client_telefon: currentInvoiceData.client.Telefon,
                client_localitate: currentInvoiceData.client.Localitate || currentInvoiceData.client.Adresa,
                subtotal: currentInvoiceData.subtotal,
                tva: currentInvoiceData.tva,
                total: currentInvoiceData.total,
                observatii: currentInvoiceData.notes,
                termeni_plata: currentInvoiceData.paymentTerms,
                produse: currentInvoiceData.products.map(product => ({
                    nume: product.name,
                    cantitate: product.quantity,
                    pret: product.price,
                    total: product.total
                }))
            };

            console.log('💾 Salvez factura în baza de date SmartBill:', invoiceData);
            
            try {
                const response = await fetch('/api/save_factura', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });

                console.log('💾 Răspuns salvare factură:', response);
                console.log('💾 Status salvare:', response.status);
                
                const data = await response.json();
                console.log('💾 Date primite după salvare:', data);
                
                if (!data.success) {
                    throw new Error(data.message || 'Eroare necunoscută la salvare');
                }
                
                console.log('✅ Factura salvată cu succes în baza de date SmartBill');
                return data;
                
            } catch (error) {
                console.error('❌ Eroare la salvarea în baza de date:', error);
                throw error;
            }
        }

        function saveDraft() {
            toastr.info('Funcția de salvare ciornă va fi implementată în versiunea finală');
        }

        function openNewClientModal() {
            document.getElementById('newClientModal').style.display = 'block';
        }

        function closeNewClientModal() {
            document.getElementById('newClientModal').style.display = 'none';
        }

        // Gestionează adăugarea clientului nou
        document.getElementById('newClientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const clientData = {
                cif: document.getElementById('newClientCIF').value,
                nume: document.getElementById('newClientName').value,
                email: document.getElementById('newClientEmail').value,
                telefon: document.getElementById('newClientPhone').value,
                adresa: document.getElementById('newClientAddress').value
            };

            console.log('Trimit datele clientului în SmartBill:', clientData);
            
            fetch('/api/add_client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(clientData)
            })
            .then(response => {
                console.log('Răspuns client primit:', response);
                console.log('Status client:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    toastr.success('✅ Clientul a fost adăugat cu succes în SmartBill!', 'Salvare reușită');
                    loadClients(); // Reîncarcă lista de clienți
                    
                    // Mesajul dispare automat după 2 secunde și se închide modalul
                    setTimeout(() => {
                        toastr.clear();
                        closeNewClientModal();
                    }, 2000);
                } else {
                    toastr.error(data.message || 'Eroare necunoscută');
                }
            })
            .catch(error => {
                console.error('Eroare la adăugarea clientului:', error);
                toastr.error('Nu s-a putut adăuga clientul: ' + error.message);
            });
        });

        // Modalele se închid doar prin butoanele "Anulează" sau "Salvează"
        // Eliminat închiderea la click în afara modalului pentru o experiență mai bună

        // Dropdown functionality pentru header
        document.addEventListener('DOMContentLoaded', function() {
            const userButton = document.getElementById('userButton');
            const userDropdown = document.getElementById('userDropdown');
            const appsButton = document.getElementById('appsButton');
            const appsDropdown = document.getElementById('appsDropdown');
            const helpButton = document.getElementById('helpButton');
            const helpDropdown = document.getElementById('helpDropdown');

            // Toggle dropdowns
            function toggleDropdown(button, dropdown) {
                const isActive = dropdown.classList.contains('active');
                
                // Close all dropdowns
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.classList.remove('active');
                });
                
                // Toggle current dropdown
                if (!isActive) {
                    dropdown.classList.add('active');
                }
            }

            // Event listeners pentru header dropdown-uri
            if (userButton && userDropdown) {
                userButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown(userButton, userDropdown);
                });
            }

            if (appsButton && appsDropdown) {
                appsButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown(appsButton, appsDropdown);
                });
            }

            if (helpButton && helpDropdown) {
                helpButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown(helpButton, helpDropdown);
                });
            }

            // Search functionality
            const searchIcon = document.querySelector('.header-icon[title="Căutare"]');
            if (searchIcon) {
                searchIcon.addEventListener('click', function() {
                    openSearchModal();
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.dropdown').forEach(d => {
                    d.classList.remove('active');
                });
            });

            // Prevent dropdown from closing when clicking inside
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
        });

        // Search Modal functionality
        let searchResults = [];

        function openSearchModal() {
            console.log('🔍 Deschid modalul de căutare facturi');
            document.getElementById('searchModal').style.display = 'block';
            // Setează data de astăzi ca dată până la
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('searchDateTo').value = today;
            
            // Setează data de acum o lună ca dată de la
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            document.getElementById('searchDateFrom').value = oneMonthAgo.toISOString().split('T')[0];
        }

        function closeSearchModal() {
            document.getElementById('searchModal').style.display = 'none';
        }

        // Funcție pentru butonul "Resetează Filtrele"
        function resetSearchFilters() {
            console.log('🔄 Resetez filtrele de căutare');
            document.getElementById('searchInvoiceNumber').value = '';
            document.getElementById('searchClientName').value = '';
            document.getElementById('searchClientCIF').value = '';
            document.getElementById('searchDateFrom').value = '';
            document.getElementById('searchDateTo').value = '';
            document.getElementById('searchStatus').value = '';
            document.getElementById('searchMinAmount').value = '';
            document.getElementById('searchMaxAmount').value = '';
            
            // Resetează și rezultatele
            document.getElementById('searchResultsContainer').innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h3>Căutați facturile dvs.</h3>
                    <p>Utilizați filtrele de mai sus pentru a găsi facturile dorite</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = 'Introduceți criteriile de căutare și apăsați "Caută Facturi"';
            document.getElementById('exportBtn').style.display = 'none';
            
            toastr.info('✅ Filtrele au fost resetate');
        }

        // Funcție pentru butonul "Caută Facturi (Real)" - cu endpoint real
        async function searchInvoices() {
            console.log('🔍 === ÎNCEPE CĂUTAREA REALĂ ===');
            
            // Colectează criteriile de căutare
            const searchCriteria = {
                invoice_number: document.getElementById('searchInvoiceNumber').value.trim(),
                client_name: document.getElementById('searchClientName').value.trim(),
                client_cif: document.getElementById('searchClientCIF').value.trim(),
                date_from: document.getElementById('searchDateFrom').value,
                date_to: document.getElementById('searchDateTo').value,
                status: document.getElementById('searchStatus').value,
                min_amount: document.getElementById('searchMinAmount').value,
                max_amount: document.getElementById('searchMaxAmount').value
            };

            console.log('🔍 Criterii căutare:', searchCriteria);

            // Validare - cel puțin un criteriu trebuie completat
            const hasAnyCriteria = Object.values(searchCriteria).some(value => value !== '' && value !== null);
            if (!hasAnyCriteria) {
                toastr.warning('⚠️ Vă rugăm să completați cel puțin un criteriu de căutare');
                return;
            }

            // Afișează loading
            document.getElementById('searchResultsContainer').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <h3>Se caută facturile...</h3>
                    <p>Vă rugăm să așteptați</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = 'Căutare în curs...';

            try {
                // Apelează API-ul pentru căutare
                console.log('🔍 Trimit request la /api/search_facturi');
                const response = await fetch('/api/search_facturi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchCriteria)
                });

                console.log('🔍 Răspuns API căutare:', response.status, response.statusText);

                // Verifică dacă răspunsul este OK
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Răspuns negativ de la server:', errorText);
                    throw new Error(`❌ Endpoint de căutare nu funcționează (${response.status})`);
                }

                // Verifică content-type
                const contentType = response.headers.get('content-type');
                console.log('🔍 Content-Type:', contentType);

                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('❌ Răspuns nu este JSON:', responseText.substring(0, 500));
                    throw new Error('❌ Server-ul a returnat text/html în loc de JSON. Verifică endpoint-ul.');
                }

                const result = await response.json();
                console.log('🔍 Date primite (JSON valid):', result);

                if (result.success) {
                    searchResults = result.data;
                    displaySearchResults(searchResults);
                    
                    const count = searchResults.length;
                    document.getElementById('resultsCount').textContent = 
                        count === 0 ? 'Nu au fost găsite facturi' : 
                        count === 1 ? 'A fost găsită 1 factură' : 
                        `Au fost găsite ${count} facturi`;
                    
                    // Afișează butonul de export doar dacă sunt rezultate
                    document.getElementById('exportBtn').style.display = count > 0 ? 'inline-block' : 'none';
                    
                    if (count > 0) {
                        toastr.success(`✅ Au fost găsite ${count} facturi`);
                    } else {
                        toastr.info('ℹ️ Nu au fost găsite facturi cu criteriile specificate');
                    }
                } else {
                    throw new Error(result.message || 'Eroare necunoscută la căutare');
                }

            } catch (error) {
                console.error('❌ Eroare completă la căutarea facturilor:', error);
                
                let errorMessage = error.message;
                if (errorMessage.includes('Unexpected token')) {
                    errorMessage = '❌ Serverul a returnat HTML în loc de JSON. Verifică că endpoint-ul /api/search_facturi există și funcționează.';
                }
                
                toastr.error('❌ Eroare: ' + errorMessage);
                
                document.getElementById('searchResultsContainer').innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Eroare la căutare</h3>
                        <p>${errorMessage}</p>
                        <small>Verificați consola browser-ului pentru mai multe detalii</small>
                    </div>
                `;
                document.getElementById('resultsCount').textContent = 'Eroare la căutare';
            }
        }

        function displaySearchResults(results) {
            console.log('📊 Afișez rezultatele căutării:', results.length, 'facturi');
            
            if (results.length === 0) {
                document.getElementById('searchResultsContainer').innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-file-invoice"></i>
                        <h3>Nu au fost găsite facturi</h3>
                        <p>Încercați să modificați criteriile de căutare</p>
                    </div>
                `;
                return;
            }

            // Generează tabelul cu rezultate
            const tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Nr. Factură</th>
                            <th>Data Emiterii</th>
                            <th>Client</th>
                            <th>CIF</th>
                            <th>Subtotal</th>
                            <th>TVA</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Acțiuni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(invoice => `
                            <tr>
                                <td><strong>${invoice.numar_factura || 'N/A'}</strong></td>
                                <td>${formatDate(invoice.data_emitere) || 'N/A'}</td>
                                <td>${invoice.client_nume || 'N/A'}</td>
                                <td>${invoice.client_cif || 'N/A'}</td>
                                <td class="amount">${formatAmount(invoice.subtotal)} RON</td>
                                <td class="amount">${formatAmount(invoice.tva)} RON</td>
                                <td class="amount"><strong>${formatAmount(invoice.total)} RON</strong></td>
                                <td>
                                    <span class="status-badge status-${invoice.status || 'emisa'}">
                                        ${getStatusText(invoice.status || 'emisa')}
                                    </span>
                                </td>
                                <td>
                                    <button class="table-action" onclick="viewInvoice('${invoice.id}')" title="Vizualizează">
                                        👁️
                                    </button>
                                    <button class="table-action" onclick="editInvoice('${invoice.id}')" title="Editează">
                                        ✏️
                                    </button>
                                    <button class="table-action" onclick="downloadInvoice('${invoice.id}')" title="Descarcă PDF">
                                        📄
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('searchResultsContainer').innerHTML = tableHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ro-RO');
            } catch (e) {
                return dateString;
            }
        }

        function formatAmount(amount) {
            if (amount === null || amount === undefined) return '0.00';
            return parseFloat(amount).toFixed(2);
        }

        function getStatusText(status) {
            const statusMap = {
                'emisa': 'Emisă',
                'platita': 'Plătită', 
                'anulata': 'Anulată'
            };
            return statusMap[status] || 'Emisă';
        }

        // Funcții pentru acțiunile din tabel
        function viewInvoice(invoiceId) {
            console.log('👁️ Vizualizez factura:', invoiceId);
            toastr.info(`Vizualizarea facturii ${invoiceId} va fi implementată în curând`);
        }

        function editInvoice(invoiceId) {
            console.log('✏️ Editez factura:', invoiceId);
            toastr.info(`Editarea facturii ${invoiceId} va fi implementată în curând`);
        }

        function downloadInvoice(invoiceId) {
            console.log('📄 Descarc factura:', invoiceId);
            toastr.info(`Descărcarea PDF pentru factura ${invoiceId} va fi implementată în curând`);
        }

        function exportResults() {
            console.log('📊 Export Excel pentru', searchResults.length, 'facturi');
            
            if (searchResults.length === 0) {
                toastr.warning('Nu există rezultate pentru export');
                return;
            }

            // Pregătește datele pentru export
            const exportData = searchResults.map(invoice => ({
                'Nr. Factură': invoice.numar_factura || '',
                'Data Emiterii': formatDate(invoice.data_emitere),
                'Data Scadentei': formatDate(invoice.data_scadenta),
                'Client': invoice.client_nume || '',
                'CIF': invoice.client_cif || '',
                'Email': invoice.client_email || '',
                'Telefon': invoice.client_telefon || '',
                'Subtotal (RON)': formatAmount(invoice.subtotal),
                'TVA (RON)': formatAmount(invoice.tva),
                'Total (RON)': formatAmount(invoice.total),
                'Status': getStatusText(invoice.status || 'emisa'),
                'Observații': invoice.observatii || ''
            }));

            // Creează și descarcă fișierul CSV
            const csvContent = convertToCSV(exportData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `facturi_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            toastr.success(`✅ Export reușit! ${searchResults.length} facturi exportate`);
        }

        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    // Escape commas and quotes
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        // Închide modalul când se face click în afara lui
        document.getElementById('searchModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSearchModal();
            }
        });

        // Funcție pentru butonul "Test Endpoint" - verifică dacă API-ul funcționează
        async function testSearchEndpoint() {
            console.log('🧪 === TESTEZ ENDPOINT-UL ===');
            
            try {
                toastr.info('🔧 Testez conexiunea la endpoint...');
                
                const response = await fetch('/api/search_facturi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_name: 'test'
                    })
                });
                
                console.log('📡 Status răspuns:', response.status);
                console.log('📡 Headers răspuns:', [...response.headers.entries()]);
                
                const responseText = await response.text();
                console.log('📡 Răspuns brut:', responseText);
                
                // Încearcă să parseze ca JSON
                try {
                    const jsonData = JSON.parse(responseText);
                    console.log('✅ JSON valid primit:', jsonData);
                    toastr.success('✅ Endpoint funcționează! JSON valid primit.');
                } catch (e) {
                    console.log('❌ Nu este JSON valid:', e.message);
                    console.log('📄 Răspuns HTML:', responseText.substring(0, 200));
                    toastr.error('❌ Endpoint de căutare nu funcționează - returnează HTML în loc de JSON');
                }
                
            } catch (error) {
                console.error('❌ Eroare la testarea endpoint-ului:', error);
                toastr.error('❌ Nu se poate conecta la endpoint: ' + error.message);
            }
        }

        // Funcție pentru butonul "Test cu Date Mock" - date de test
        async function searchInvoicesMock() {
            console.log('🧪 === TESTARE CU DATE MOCK ===');
            
            // Simulează delay de rețea
            document.getElementById('searchResultsContainer').innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <h3>Se caută facturile (mock)...</h3>
                    <p>Testare cu date fictive</p>
                </div>
            `;
            document.getElementById('resultsCount').textContent = 'Căutare în curs (mock)...';
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Date mock pentru testare - CONSISTENTE cu Excel-ul nou
            const mockResults = [
                {
                    id: 1,
                    numar_factura: 'FACT-001',
                    data_emitere: '2025-08-01',
                    data_scadenta: '2025-09-01',
                    client_nume: 'SC DEMO SRL',
                    client_cif: 'RO12345678',
                    client_email: 'demo@demo.ro',
                    client_telefon: '0721234567',
                    subtotal: 1300.00,
                    tva: 247.00,
                    total: 1547.00,
                    status: 'emisa',
                    observatii: 'Factură pentru servicii IT'
                },
                {
                    id: 2,
                    numar_factura: 'FACT-002',
                    data_emitere: '2025-08-02',
                    data_scadenta: '2025-09-02',
                    client_nume: 'SC TEST IMPEX',
                    client_cif: 'RO87654321',
                    client_email: 'office@testimex.ro',
                    client_telefon: '0739987654',
                    subtotal: 2800.50,
                    tva: 532.10,
                    total: 3332.60,
                    status: 'platita',
                    observatii: 'Dezvoltare aplicații web'
                },
                {
                    id: 3,
                    numar_factura: 'FACT-003',
                    data_emitere: '2025-08-03',
                    data_scadenta: '2025-09-03',
                    client_nume: 'Popescu Ion PFA',
                    client_cif: '1234567890123',
                    client_email: 'popescu@email.ro',
                    client_telefon: '0743555666',
                    subtotal: 1200.00,
                    tva: 228.00,
                    total: 1428.00,
                    status: 'emisa',
                    observatii: 'Consultanță IT'
                },
                {
                    id: 4,
                    numar_factura: 'FACT-004',
                    data_emitere: '2025-08-04',
                    data_scadenta: '2025-09-04',
                    client_nume: 'SC ALPHA BETA',
                    client_cif: 'RO11223344',
                    client_email: 'alphabeta@email.ro',
                    client_telefon: '0758889999',
                    subtotal: 3500.00,
                    tva: 665.00,
                    total: 4165.00,
                    status: 'platita',
                    observatii: 'Audit sistem'
                },
                {
                    id: 5,
                    numar_factura: 'FACT-005',
                    data_emitere: '2025-08-05',
                    data_scadenta: '2025-09-05',
                    client_nume: 'Ionescu Maria PFA',
                    client_cif: '9876543210987',
                    client_email: 'maria@email.ro',
                    client_telefon: '0766111222',
                    subtotal: 890.00,
                    tva: 169.10,
                    total: 1059.10,
                    status: 'platita',
                    observatii: 'Mentenanță sistem'
                }
            ];
            
            // Filtrează rezultatele pe baza criteriilor (simulare simplă)
            const searchCriteria = {
                invoice_number: document.getElementById('searchInvoiceNumber').value.trim(),
                client_name: document.getElementById('searchClientName').value.trim(),
                client_cif: document.getElementById('searchClientCIF').value.trim(),
                status: document.getElementById('searchStatus').value
            };
            
            let filteredResults = mockResults;
            
            if (searchCriteria.invoice_number) {
                filteredResults = filteredResults.filter(invoice => 
                    invoice.numar_factura.toLowerCase().includes(searchCriteria.invoice_number.toLowerCase())
                );
            }
            
            if (searchCriteria.client_name) {
                filteredResults = filteredResults.filter(invoice => 
                    invoice.client_nume.toLowerCase().includes(searchCriteria.client_name.toLowerCase())
                );
            }
            
            if (searchCriteria.client_cif) {
                filteredResults = filteredResults.filter(invoice => 
                    invoice.client_cif.toLowerCase().includes(searchCriteria.client_cif.toLowerCase())
                );
            }
            
            if (searchCriteria.status) {
                filteredResults = filteredResults.filter(invoice => 
                    invoice.status === searchCriteria.status
                );
            }
            
            searchResults = filteredResults;
            displaySearchResults(searchResults);
            
            const count = searchResults.length;
            document.getElementById('resultsCount').textContent = 
                count === 0 ? 'Nu au fost găsite facturi (date mock)' : 
                count === 1 ? 'A fost găsită 1 factură (date mock)' : 
                `Au fost găsite ${count} facturi (date mock)`;
            
            document.getElementById('exportBtn').style.display = count > 0 ? 'inline-block' : 'none';
            
            toastr.success(`✅ Testare cu date mock: ${count} facturi găsite`);
        }
    </script>
</body>
</html>