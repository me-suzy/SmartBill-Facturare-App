<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBill - Clienți</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <style>
        .clients-container {
            padding: 30px;
        }
        
        .clients-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .clients-title {
            font-size: 24px;
            color: var(--dark);
            font-weight: 300;
        }
        
        .add-client-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .add-client-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .clients-table {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .table-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            font-weight: 500;
        }
        
        .table-content {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .client-row {
            display: grid;
            grid-template-columns: 80px 120px 2fr 150px 120px 120px 120px 100px;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            align-items: center;
            transition: var(--transition);
        }
        
		/* Păstrează hover pentru rândurile normale */
		.client-row:hover {
			background: #f8f9fa;
		}

		/* Dezactivează hover doar pentru antet */
		.table-header .client-row:hover {
			background: transparent !important;
		}

        .client-row:last-child {
            border-bottom: none;
        }
        
        .client-id {
            font-weight: 500;
            color: var(--primary);
        }
        
        .client-cif {
            font-family: monospace;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .client-name {
            font-weight: 500;
            color: var(--dark);
        }
        
        .client-email {
            color: var(--primary);
            text-decoration: none;
        }
        
        .client-phone {
            font-family: monospace;
        }
        
        .client-location {
            background: var(--light);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
        }
        

    .client-balance {
        display: inline-block; /* Ensures it behaves inline but can have margin/padding */
        margin-right: 10px; /* Space before the buttons */
        text-align: center; /* Centers the text within the div */
        width: 150px; /* Optional: Fixed width to ensure consistent alignment */
    }
    /* Optional: Adjust the parent td alignment if needed */
    td {
        text-align: center; /* Centers all content in the td, including the div and buttons */
    }

        
        .balance-positive {
            color: var(--success);
        }
        
        .balance-negative {
            color: var(--danger);
        }
        
        .balance-zero {
            color: #666;
        }
        
        .client-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }
        
        .edit-btn {
            background: var(--warning);
            color: white;
        }
        
        .edit-btn:hover {
            background: #e67e22;
        }
        
        .delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: var(--radius);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        /* Asigură că butoanele sunt mereu vizibile */
        .modal-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0;
            border-top: 1px solid var(--border);
            margin-top: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 20px;
            color: var(--dark);
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            transition: var(--transition);
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 300;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Loading indicator */
        .loading::after {
            content: "Încărcare...";
            display: block;
            text-align: center;
            padding: 10px;
            color: #666;
            font-style: italic;
        }
        
        /* Toast notifications customization */
        .toast-success {
            background-color: var(--success) !important;
        }
        
        .toast-error {
            background-color: var(--danger) !important;
        }
        
        .toast-warning {
            background-color: var(--warning) !important;
        }
        
        .toast-info {
            background-color: var(--primary) !important;
        }

        /* CSS pentru mesajul de succes */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
            z-index: 9999;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease-out;
        }

        .success-message .icon {
            font-size: 18px;
        }

        .success-message.fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h2>💰 SmartBill</h2>
                <span>FACTURARE</span>
            </div>
            <nav class="nav-menu">
                <a href="/dashboard" class="nav-item">📊 Dashboard</a>
                <div class="nav-group">
                    <span class="nav-title">📄 Emitere</span>
                    <a href="/factura" class="nav-subitem">Factură</a>
                    <a href="/bon-fiscal" class="nav-subitem">Bon Fiscal</a>
                    <a href="/factura-storno" class="nav-subitem">Factură Storno</a>
                </div>
                <a href="/rapoarte" class="nav-item">📈 Rapoarte</a>
                <a href="/configurare" class="nav-item">⚙️ Configurare</a>
                <div class="nav-group">
                    <span class="nav-title">📝 Nomenclatoare</span>
                    <a href="/produse" class="nav-subitem">Produse</a>
                    <a href="/clienti" class="nav-subitem active">Clienți</a>
                </div>
            </nav>
        </div>

        <div class="main-content">
            <header>
                <h1>Clienți</h1>
                <div class="user-info">
                    <span>TIP B. SRL</span>
                </div>
            </header>

            <div class="clients-container">
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-value" id="total-clients">0</div>
                        <div class="stat-label">Total Clienți</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="active-clients">0</div>
                        <div class="stat-label">Clienți Activi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-balance">0</div>
                        <div class="stat-label">Sold Total (RON)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="debtors">0</div>
                        <div class="stat-label">Clienți cu Datorii</div>
                    </div>
                </div>

                <div class="clients-header">
                    <h2 class="clients-title">Lista Clienți</h2>
                    <button class="add-client-btn" onclick="openAddModal()">
                        ➕ Adaugă Client
                    </button>
                </div>

                <div class="clients-table">
                    <div class="table-header">
                        <div class="client-row">
                            <div>ID</div>
                            <div>CIF</div>
                            <div>Nume</div>
                            <div>Email</div>
                            <div>Telefon</div>
                            <div>Localitate</div>
                            <div>Sold (RON)</div>
                            <div>Acțiuni</div>
                        </div>
                    </div>
                    <div class="table-content" id="clients-table-body">
                        <!-- Clienții vor fi încărcați dinamic -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pentru adăugare/editare client -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Adaugă Client Nou</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="clientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">CIF/CNP</label>
                        <input type="text" class="form-input" id="clientCIF" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nume Client</label>
                        <input type="text" class="form-input" id="clientName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="clientEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefon</label>
                        <input type="tel" class="form-input" id="clientPhone" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Localitate</label>
                        <input type="text" class="form-input" id="clientCity" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Județ</label>
                        <select class="form-input" id="clientCounty" required>
                            <option value="">Selectează Județul</option>
                            <option value="Alba">Alba</option>
                            <option value="Arad">Arad</option>
                            <option value="Argeș">Argeș</option>
                            <option value="Bacău">Bacău</option>
                            <option value="Bihor">Bihor</option>
                            <option value="Bistrița-Năsăud">Bistrița-Năsăud</option>
                            <option value="Botoșani">Botoșani</option>
                            <option value="Brașov">Brașov</option>
                            <option value="Brăila">Brăila</option>
                            <option value="București">București</option>
                            <option value="Buzău">Buzău</option>
                            <option value="Călărași">Călărași</option>
                            <option value="Caraș-Severin">Caraș-Severin</option>
                            <option value="Cluj">Cluj</option>
                            <option value="Constanța">Constanța</option>
                            <option value="Covasna">Covasna</option>
                            <option value="Dâmbovița">Dâmbovița</option>
                            <option value="Dolj">Dolj</option>
                            <option value="Galați">Galați</option>
                            <option value="Giurgiu">Giurgiu</option>
                            <option value="Gorj">Gorj</option>
                            <option value="Harghita">Harghita</option>
                            <option value="Hunedoara">Hunedoara</option>
                            <option value="Ialomița">Ialomița</option>
                            <option value="Iași">Iași</option>
                            <option value="Ilfov">Ilfov</option>
                            <option value="Maramureș">Maramureș</option>
                            <option value="Mehedinți">Mehedinți</option>
                            <option value="Mureș">Mureș</option>
                            <option value="Neamț">Neamț</option>
                            <option value="Olt">Olt</option>
                            <option value="Prahova">Prahova</option>
                            <option value="Sălaj">Sălaj</option>
                            <option value="Satu Mare">Satu Mare</option>
                            <option value="Sibiu">Sibiu</option>
                            <option value="Suceava">Suceava</option>
                            <option value="Teleorman">Teleorman</option>
                            <option value="Timiș">Timiș</option>
                            <option value="Tulcea">Tulcea</option>
                            <option value="Vâlcea">Vâlcea</option>
                            <option value="Vaslui">Vaslui</option>
                            <option value="Vrancea">Vrancea</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresa Completă</label>
                    <input type="text" class="form-input" id="clientAddress" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cod Postal</label>
                        <input type="text" class="form-input" id="clientPostalCode" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="text" class="form-input" id="clientWebsite" placeholder="ex: www.example.com">
                    </div>
                </div>
				<div class="form-group">
					<label class="form-label">Sold (RON)</label>
					<input type="number" class="form-input" id="clientBalance" step="0.01">
				</div>
                <div class="form-group">
                    <label class="form-label">Persoană de Contact</label>
                    <input type="text" class="form-input" id="clientContactPerson">
                </div>
                <div class="form-group">
                    <label class="form-label">Observații</label>
                    <textarea class="form-input" id="clientNotes" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Anulează</button>
                    <button type="submit" class="btn-primary" id="saveClientBtn">
                        <i class="fas fa-save"></i> Salvează Client
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        // Configurare toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "5000",
            "extendedTimeOut": "2000"
        };

        // Funcții pentru mesajul de succes și gestionarea modal-urilor
        function showSuccessMessage(message) {
            const existingMessages = document.querySelectorAll('.success-message');
            existingMessages.forEach(msg => msg.remove());

            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `<i class="fas fa-check-circle icon"></i><span>${message}</span>`;
            document.body.appendChild(successDiv);

            setTimeout(() => {
                successDiv.classList.add('fade-out');
                setTimeout(() => { 
                    if (successDiv.parentNode) successDiv.parentNode.removeChild(successDiv); 
                }, 300);
            }, 2000);
        }

        function closeModal() {
            document.getElementById('clientModal').style.display = 'none';
            editingClientId = null;
        }

        function resetForm(formId) {
            const form = document.getElementById(formId);
            if (form) form.reset();
        }

        function handleSaveSuccess(message, modalId, formId = null, reloadTable = null) {
            showSuccessMessage(message);
            if (modalId) closeModal();
            if (formId) setTimeout(() => resetForm(formId), 300);
            if (reloadTable && typeof reloadTable === 'function') setTimeout(reloadTable, 500);
        }

        let clients = [];
        let editingClientId = null;

        // Încarcă clienții la pornirea paginii
        console.log('=== CLIENTI.HTML SCRIPT LOADED ===');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded pentru clienti.html');
            console.log('Încerc să încarc clienții...');
            
            fetch('/api/get_clienti')
                .then(response => {
                    console.log('TEST API - Status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('TEST API - Date primite:', data.length, 'clienți');
                    console.log('TEST API - Primul client:', data[0]);
                })
                .catch(error => {
                    console.error('TEST API - Eroare:', error);
                });
            
            loadClients();
        });

        function loadClients() {
            const tableBody = document.getElementById('clients-table-body');
            tableBody.classList.add('loading');
            
            fetch('/api/get_clienti')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    clients = data;
                    displayClients();
                    updateStats();
                    toastr.success('Clienții au fost încărcați cu succes!');
                })
                .catch(error => {
                    console.error('Eroare la încărcarea clienților:', error);
                    toastr.error('Nu s-au putut încărca clienții: ' + error.message);
                })
                .finally(() => {
                    tableBody.classList.remove('loading');
                });
        }

        function displayClients() {
            const tableBody = document.getElementById('clients-table-body');
            
            if (!tableBody) {
                console.error('Elementul clients-table-body nu a fost găsit!');
                return;
            }
            
            tableBody.innerHTML = '';

            if (clients.length === 0) {
                tableBody.innerHTML = '<div class="no-data">Nu sunt clienți în baza de date</div>';
                return;
            }

            clients.forEach((client) => {
                const row = document.createElement('div');
                row.className = 'client-row';
                
                const balanceClass = client.Sold_Curent > 0 ? 'balance-negative' : 
                                   client.Sold_Curent < 0 ? 'balance-positive' : 'balance-zero';
                
                row.innerHTML = `
                    <div class="client-id">${client.ID}</div>
                    <div class="client-cif">${client.CIF}</div>
                    <div class="client-name">${client.Nume}</div>
                    <div><a href="mailto:${client.Client_Email || ''}" class="client-email">${client.Client_Email || ''}</a></div>
                    <div class="client-phone">${client.Client_Telefon || ''}</div>
                    <div class="client-location">${client.Client_Localitate || ''}</div>
                    <div class="client-balance ${balanceClass}">${client.Sold_Curent.toFixed(2)}</div>
                    <div class="client-actions">
                        <button class="action-btn edit-btn" onclick="editClient(${client.ID})">✏️</button>
                        <button class="action-btn delete-btn" onclick="deleteClient(${client.ID})">🗑️</button>
                    </div>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function updateStats() {
            const totalClients = clients.length;
            const activeClients = clients.filter(c => c.Status === 'Activ').length;
            const totalBalance = clients.reduce((sum, c) => sum + c.Sold_Curent, 0);
            const debtors = clients.filter(c => c.Sold_Curent > 0).length;

            document.getElementById('total-clients').textContent = totalClients;
            document.getElementById('active-clients').textContent = activeClients;
            document.getElementById('total-balance').textContent = totalBalance.toFixed(2);
            document.getElementById('debtors').textContent = debtors;
        }

        function openAddModal() {
            editingClientId = null;
            document.getElementById('modalTitle').textContent = 'Adaugă Client Nou';
            document.getElementById('clientForm').reset();
            document.getElementById('clientModal').style.display = 'block';
        }

        function editClient(clientId) {
            const client = clients.find(c => c.ID === clientId);
            if (!client) return;

            editingClientId = clientId;
            document.getElementById('modalTitle').textContent = 'Editează Client';
            
            // Populează formularul
            document.getElementById('clientCIF').value = client.CIF;
            document.getElementById('clientName').value = client.Nume;
            document.getElementById('clientEmail').value = client.Client_Email || '';
            document.getElementById('clientPhone').value = client.Client_Telefon || '';
            document.getElementById('clientCity').value = client.Client_Localitate || '';
            document.getElementById('clientCounty').value = client.Client_Judet || '';
            document.getElementById('clientAddress').value = client.Client_Adresa || '';
            document.getElementById('clientPostalCode').value = client.Client_Cod_Postal || '';
            document.getElementById('clientWebsite').value = client.Website || '';
            document.getElementById('clientContactPerson').value = client.Persoana_Contact || '';
            document.getElementById('clientNotes').value = client.Observatii || '';
			document.getElementById('clientBalance').value = client.Sold_Curent || 0;

            document.getElementById('clientModal').style.display = 'block';
        }

        function deleteClient(clientId) {
            if (!confirm('Ești sigur că vrei să ștergi acest client?')) return;

            fetch(`/api/delete_client/${clientId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccessMessage('Client șters cu succes!');
                    loadClients();
                } else {
                    toastr.error('Eroare la ștergerea clientului: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Eroare la ștergerea clientului:', error);
                toastr.error('Nu s-a putut șterge clientul');
            });
        }

        // Funcție pentru formatarea URL-ului
        function formatWebsiteUrl(url) {
            if (!url) return '';
            url = url.trim();
            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            return url;
        }

        // Gestionează trimiterea formularului cu noua funcționalitate
        document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const clientData = {
                cif: document.getElementById('clientCIF').value,
                nume: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                telefon: document.getElementById('clientPhone').value,
                localitate: document.getElementById('clientCity').value,
                judet: document.getElementById('clientCounty').value,
                adresa: document.getElementById('clientAddress').value,
                cod_postal: document.getElementById('clientPostalCode').value,
                website: formatWebsiteUrl(document.getElementById('clientWebsite').value),
                persoana_contact: document.getElementById('clientContactPerson').value,
                observatii: document.getElementById('clientNotes').value
            };

            const url = editingClientId ? `/api/update_client/${editingClientId}` : '/api/add_client';
            const method = editingClientId ? 'PUT' : 'POST';

            console.log('Trimit datele clientului:', clientData);
            console.log('URL client:', url);
            console.log('Method client:', method);
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(clientData)
            })
            .then(response => {
                console.log('Răspuns client primit:', response);
                console.log('Status client:', response.status);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const message = editingClientId ? 'Client actualizat cu succes!' : 'Client adăugat cu succes!';
                    
                    // Nouă funcționalitate: mesaj de succes și închidere automată
                    handleSaveSuccess(message, 'clientModal', 'clientForm', loadClients);
                } else {
                    toastr.error(data.message || 'Eroare necunoscută');
                }
            })
            .catch(error => {
                console.error('Eroare la salvare:', error);
                toastr.error('Nu s-a putut salva clientul: ' + error.message);
            });
        });
    </script>
</body>
</html>